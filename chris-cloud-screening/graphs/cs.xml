<graph>
    <id>cloud-screening</id>

    <node>
        <id>features</id>
        <operator>chris.ExtractFeatures</operator>
        <sources>
            <source>${input}</source>
        </sources>
    </node>

    <node>
        <id>clusters</id>
        <operator>chris.FindClusters</operator>
        <sources>
            <source>features</source>
        </sources>
        <parameters>
            <sourceBandNames>brightness_vis,brightness_nir,whiteness_vis,whiteness_nir,wv</sourceBandNames>
            <clusterCount>14</clusterCount>
            <iterationCount>40</iterationCount>
        </parameters>
    </node>

    <node>
        <id>map</id>
        <operator>chris.MakeClusterMap</operator>
        <sources>
            <source>clusters</source>
        </sources>
        <parameters>
            <backgroundClusterIndexes>0,8</backgroundClusterIndexes>
        </parameters>
    </node>

    <node>
        <id>cloudProbability</id>
        <operator>chris.Accumulate</operator>
        <sources>
            <source>map</source>
        </sources>
        <parameters>
            <sourceBands>probability_10,probability_11,probability_13</sourceBands>
            <targetBand>cloud_probability</targetBand>
        </parameters>
    </node>

    <node>
        <id>endmembers</id>
        <operator>chris.ExtractEndmembers</operator>
        <sources>
            <reflectances>${input}</reflectances>
            <features>features</features>
            <clusters>map</clusters>
        </sources>
        <parameters>
            <cloudClusterIndexes>9,10,12</cloudClusterIndexes>
            <surfaceClusterIndexes>1,2,3,4,5,6,7,11,13</surfaceClusterIndexes>
            <surfaceClusterLabels>1,2,3,4,5,6,7,11,13</surfaceClusterLabels>
        </parameters>
    </node>

    <node>
        <id>cloudAbundance</id>
        <operator>Unmix</operator>
        <sources>
            <sourceProduct>${input}</sourceProduct>
        </sources>
        <parameters>
            <endmembers ref="endmembers.endmembers"/>
            <unmixingModelName>Fully Constrained LSU</unmixingModelName>
            <sourceBands>
                <band>reflectance_1</band>
                <band>reflectance_2</band>
                <band>reflectance_3</band>
                <band>reflectance_4</band>
                <band>reflectance_5</band>
                <band>reflectance_6</band>
                <band>reflectance_7</band>
                <band>reflectance_8</band>
                <band>reflectance_9</band>
                <band>reflectance_10</band>
                <band>reflectance_11</band>
                <band>reflectance_12</band>
                <band>reflectance_13</band>
                <band>reflectance_14</band>
                <band>reflectance_15</band>
                <band>reflectance_16</band>
                <band>reflectance_17</band>
                <band>reflectance_18</band>
                <band>reflectance_19</band>
                <band>reflectance_20</band>
                <band>reflectance_21</band>
                <band>reflectance_22</band>
                <band>reflectance_23</band>
                <band>reflectance_24</band>
                <band>reflectance_25</band>
                <band>reflectance_26</band>
                <band>reflectance_27</band>
                <band>reflectance_28</band>
                <band>reflectance_29</band>
                <band>reflectance_30</band>
                <band>reflectance_31</band>
                <band>reflectance_32</band>
                <band>reflectance_33</band>
                <band>reflectance_34</band>
                <band>reflectance_35</band>
                <band>reflectance_36</band>
                <band>reflectance_37</band>
                <band>reflectance_38</band>
                <band>reflectance_39</band>
                <band>reflectance_40</band>
                <band>reflectance_41</band>
                <band>reflectance_42</band>
                <band>reflectance_43</band>
                <band>reflectance_44</band>
                <band>reflectance_45</band>
                <band>reflectance_46</band>
                <band>reflectance_47</band>
                <band>reflectance_48</band>
                <band>reflectance_49</band>
                <band>reflectance_50</band>
                <band>reflectance_51</band>
                <band>reflectance_52</band>
                <band>reflectance_53</band>
                <band>reflectance_54</band>
                <band>reflectance_55</band>
                <band>reflectance_56</band>
                <band>reflectance_57</band>
                <band>reflectance_58</band>
                <band>reflectance_59</band>
                <band>reflectance_60</band>
                <band>reflectance_61</band>
                <band>reflectance_62</band>
            </sourceBands>
        </parameters>
    </node>

    <node>
        <id>cloudMask</id>
        <operator>BandArithmetic</operator>
        <sources>
            <cloudProbability>cloudProbability</cloudProbability>
            <cloudAbundance>cloudAbundance</cloudAbundance>
        </sources>
        <parameters>
            <targetBands>
                <targetBand>
                    <name>cloud_mask</name>
                    <expression>$cloudProbability.cloud_probability * $cloudAbundance.cloud_abundance</expression>
                    <type>float32</type>
                </targetBand>
            </targetBands>
        </parameters>
    </node>

    <node>
        <id>target</id>
        <operator>Merge</operator>
        <sources>
            <reflectances>${input}</reflectances>
            <probabilities>cloudProbability</probabilities>
            <abundances>cloudAbundance</abundances>
            <mask>cloudMask</mask>
            <map>map</map>
        </sources>
        <parameters>
            <productType>CHRIS_CLOUD</productType>
            <band>
                <product>reflectances</product>
                <nameExp>reflectance_.*</nameExp>
            </band>
            <band>
                <product>reflectances</product>
                <nameExp>mask_.*</nameExp>
            </band>
            <band>
                <product>probabilities</product>
                <name>cloud_probability</name>
            </band>
            <band>
                <product>abundances</product>
                <name>cloud_abundance</name>
            </band>
            <band>
                <product>mask</product>
                <name>cloud_mask</name>
            </band>
            <band>
                <product>map</product>
                <name>membership_mask</name>
            </band>
        </parameters>
    </node>
    
</graph>
